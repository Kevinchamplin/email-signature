<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layout Version Diagnostics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen py-10">
    <div class="max-w-3xl mx-auto bg-white shadow-xl rounded-xl p-8 space-y-8">
        <header class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Layout Version Diagnostics</h1>
                <p class="text-gray-600">Verify script versions and auth detection.</p>
            </div>
            <a href="https://apps.ironcrestsoftware.com/auth.html" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition">Open Auth</a>
        </header>

        <section class="grid md:grid-cols-2 gap-6">
            <div class="p-5 border border-gray-200 rounded-lg">
                <h2 class="text-lg font-semibold text-gray-800 mb-3">Layout Detection</h2>
                <ul class="space-y-2 text-sm text-gray-700">
                    <li><strong>IRONCREST_APP</strong>: <span id="diag-app">(pending)</span></li>
                    <li><strong>IRONCREST_LAYOUT</strong>: <span id="diag-layout">(pending)</span></li>
                </ul>
            </div>
            <div class="p-5 border border-gray-200 rounded-lg">
                <h2 class="text-lg font-semibold text-gray-800 mb-3">Script Versions</h2>
                <ul class="space-y-2 text-sm text-gray-700">
                    <li><strong>app-registry.js</strong>: v<span id="diag-app-registry">(pending)</span></li>
                    <li><strong>layout-v2.js</strong>: v<span id="diag-layout-version">(pending)</span></li>
                </ul>
            </div>
        </section>

        <section class="p-5 border border-gray-200 rounded-lg">
            <h2 class="text-lg font-semibold text-gray-800 mb-3">Authentication Status</h2>
            <div class="flex items-center gap-4">
                <div id="diag-auth-state" class="px-3 py-1 text-sm font-semibold rounded-full bg-gray-200 text-gray-700">Checkingâ€¦</div>
                <pre id="diag-auth-json" class="flex-1 bg-gray-50 border border-gray-200 rounded-lg p-3 text-xs overflow-auto">(awaiting response)</pre>
            </div>
            <div class="mt-3 text-sm text-gray-600" id="diag-cookie">Cookies: (pending)</div>
            <div class="mt-1 text-sm text-gray-600" id="diag-storage">LocalStorage ironcrest_session: (pending)</div>
        </section>

        <footer class="text-sm text-gray-500">
            <p>This page sets <code>window.IRONCREST_APP = 'email-signature'</code> and loads <code>layout-v2.js?v=13</code>.</p>
        </footer>
    </div>

    <script src="https://apps.ironcrestsoftware.com/shared/js/app-registry.js?v=12"></script>
    <script>
        window.IRONCREST_APP = 'email-signature';
        window.IRONCREST_LAYOUT = 'marketing';
    </script>
    <script src="https://apps.ironcrestsoftware.com/shared/js/layout-v2.js?v=13"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('diag-app').textContent = window.IRONCREST_APP || '(unset)';
            document.getElementById('diag-layout').textContent = window.IRONCREST_LAYOUT || '(unset)';
            document.getElementById('diag-cookie').textContent = `Cookies: ${document.cookie || '(none)'}`;
            let storedToken = null;
            try {
                storedToken = localStorage.getItem('ironcrest_session');
            } catch (storageError) {
                storedToken = `(error accessing localStorage: ${storageError.message})`;
            }
            document.getElementById('diag-storage').textContent = `LocalStorage ironcrest_session: ${storedToken || '(none)'}`;

            const detectVersion = (name) => {
                const regex = new RegExp(`${name}\\.js\\?v=(\\d+)`);
                for (const script of document.scripts) {
                    if (!script.src) continue;
                    const match = script.src.match(regex);
                    if (match) return match[1];
                }
                return 'unknown';
            };

            document.getElementById('diag-app-registry').textContent = detectVersion('app-registry');
            document.getElementById('diag-layout-version').textContent = detectVersion('layout-v2');

            try {
                const headers = {};
                if (storedToken && typeof storedToken === 'string' && storedToken.length > 0) {
                    headers['Authorization'] = `Bearer ${storedToken}`;
                    headers['X-Ironcrest-Session'] = storedToken;
                }
                const response = await fetch('https://apps.ironcrestsoftware.com/shared/api/auth.php?action=validate', {
                    credentials: 'include',
                    headers
                });
                const json = await response.json();
                const badge = document.getElementById('diag-auth-state');
                badge.textContent = json.authenticated ? 'Authenticated' : 'Guest';
                badge.className = json.authenticated
                    ? 'px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-700'
                    : 'px-3 py-1 text-sm font-semibold rounded-full bg-yellow-100 text-yellow-700';
                document.getElementById('diag-auth-json').textContent = JSON.stringify(json, null, 2);
            } catch (error) {
                const badge = document.getElementById('diag-auth-state');
                badge.textContent = 'Error';
                badge.className = 'px-3 py-1 text-sm font-semibold rounded-full bg-red-100 text-red-700';
                document.getElementById('diag-auth-json').textContent = error.message;
            }
        });
    </script>
</body>
</html>
