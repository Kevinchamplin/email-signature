<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Signatures | Email Signature Generator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-display { font-family: 'Montserrat', sans-serif; }
    </style>
    
    <!-- Unified Authentication -->
    <script src="https://apps.ironcrestsoftware.com/auth/ironcrest-auth.js"></script>
</head>
<body class="bg-gray-50 has-sidebar">

    <!-- Header -->
    <div id="app-header"></div>
    
    <!-- Sidebar -->
    <div id="app-sidebar"></div>
    
    <div id="app-content" class="flex-1">

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-display font-bold text-gray-900 mb-2">My Signatures</h1>
                <p class="text-gray-600">Manage all your saved email signatures</p>
            </div>
            <a href="app.html" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition shadow-lg">
                <i class="fas fa-plus mr-2"></i> Create New
            </a>
        </div>

        <!-- Signatures List -->
        <div id="signatures-list" class="space-y-6">
            <div class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                <p class="text-gray-600">Loading your signatures...</p>
            </div>
        </div>

        <!-- Empty State (hidden by default) -->
        <div id="empty-state" class="hidden bg-white rounded-xl shadow-lg p-12 text-center">
            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-signature text-4xl text-gray-400"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">No Signatures Yet</h3>
            <p class="text-gray-600 mb-6">Create your first professional email signature in minutes!</p>
            <a href="app.html" class="inline-block bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-4 rounded-lg font-bold text-lg hover:opacity-90 transition shadow-lg">
                <i class="fas fa-rocket mr-2"></i> Create Your First Signature
            </a>
        </div>
    </main>

    </div> <!-- Close app-content -->
    
    <!-- Footer -->
    <div id="app-footer"></div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-8 right-8 bg-white rounded-lg shadow-2xl border-2 border-gray-200 p-4 transform translate-y-32 opacity-0 transition-all duration-300 z-50 max-w-md">
        <div class="flex items-center gap-3">
            <div id="toast-icon" class="text-2xl"></div>
            <p id="toast-message" class="text-gray-900 font-semibold"></p>
        </div>
    </div>

    <!-- Email Input Modal -->
    <div id="email-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Send Signature via Email</h3>
            <p class="text-gray-600 mb-4">Enter your email address to receive your signature with installation instructions.</p>
            <input type="email" id="email-input" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none mb-4" placeholder="you@example.com">
            <div class="flex gap-3">
                <button onclick="closeEmailModal()" class="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition">Cancel</button>
                <button onclick="confirmEmail()" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">Send</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>const API_BASE = '../api';</script>
    <script src="js/auth-check.js"></script>
    <script src="https://apps.ironcrestsoftware.com/shared/js/app-registry.js?v=11"></script>
    <script>
        window.IRONCREST_APP = 'email-signature';
        window.IRONCREST_LAYOUT = 'app';
    </script>
    <script src="https://apps.ironcrestsoftware.com/shared/js/layout-v2.js?v=11"></script>
    <script>
        // Toast notification system
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const messageEl = document.getElementById('toast-message');
            
            // Set icon and colors based on type
            const types = {
                success: { icon: '‚úì', bg: 'bg-green-50', border: 'border-green-500', text: 'text-green-900' },
                error: { icon: '‚úó', bg: 'bg-red-50', border: 'border-red-500', text: 'text-red-900' },
                info: { icon: '‚Ñπ', bg: 'bg-blue-50', border: 'border-blue-500', text: 'text-blue-900' },
                warning: { icon: '‚ö†', bg: 'bg-yellow-50', border: 'border-yellow-500', text: 'text-yellow-900' }
            };
            
            const style = types[type] || types.success;
            
            icon.textContent = style.icon;
            messageEl.textContent = message;
            toast.className = `fixed bottom-8 right-8 rounded-lg shadow-2xl border-2 p-4 transition-all duration-300 z-50 max-w-md ${style.bg} ${style.border}`;
            messageEl.className = `font-semibold ${style.text}`;
            
            // Show toast
            setTimeout(() => {
                toast.style.transform = 'translateY(0)';
                toast.style.opacity = '1';
            }, 10);
            
            // Hide after 3 seconds
            setTimeout(() => {
                toast.style.transform = 'translateY(8rem)';
                toast.style.opacity = '0';
            }, 3000);
        }
        
    </script>
    <script>
        // Load user signatures
        async function loadSignatures() {
            try {
                console.log('üîç Loading signatures...');
                
                // Check auth first
                const authResponse = await fetch(`${API_BASE}/auth.php?action=validate`, {
                    credentials: 'include'
                });
                const authData = await authResponse.json();
                
                console.log('Auth check:', authData);
                
                if (!authData.success) {
                    window.location.href = 'index.html';
                    return;
                }
                
                // Load signatures from API
                console.log('Fetching signatures list...');
                const response = await fetch(`${API_BASE}/signatures.php?action=list`, {
                    credentials: 'include'
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Signatures data:', data);
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load signatures');
                }
                
                console.log(`‚úÖ Found ${data.count} signatures`);
                displaySignatures(data.signatures || []);
                
            } catch (error) {
                console.error('‚ùå Error loading signatures:', error);
                document.getElementById('signatures-list').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                        <i class="fas fa-exclamation-circle text-red-600 text-3xl mb-3"></i>
                        <p class="text-red-700 font-semibold mb-2">Failed to load signatures</p>
                        <p class="text-red-600 text-sm">${error.message}</p>
                        <button onclick="location.reload()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }
        
        function showEmptyState() {
            document.getElementById('signatures-list').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
        }
        
        function displaySignatures(signatures) {
            const list = document.getElementById('signatures-list');
            
            if (signatures.length === 0) {
                showEmptyState();
                return;
            }
            
            list.innerHTML = signatures.map(sig => {
                const config = sig.config_json;
                const name = config?.identity?.name || 'No Name';
                const title = config?.identity?.title || '';
                const company = config?.company?.name || '';
                const email = config?.contact?.email || '';
                const phone = config?.contact?.phone || '';
                
                return `
                <div class="bg-white rounded-xl shadow-md border-2 border-gray-200 hover:border-blue-400 hover:shadow-xl transition-all overflow-hidden">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-900 mb-1">${sig.title || 'Untitled Signature'}</h3>
                                <div class="flex items-center gap-4 text-sm text-gray-600">
                                    <span class="inline-flex items-center gap-1">
                                        <i class="fas fa-palette"></i>
                                        <span class="font-medium">${sig.template_key}</span>
                                    </span>
                                    <span class="inline-flex items-center gap-1">
                                        <i class="fas fa-clock"></i>
                                        <span>${new Date(sig.updated_at).toLocaleDateString()}</span>
                                    </span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editSignature('${sig.public_uuid}')" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-semibold shadow-md hover:shadow-lg">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <div class="relative">
                                    <button onclick="toggleCopyMenu('${sig.public_uuid}')" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-semibold shadow-md hover:shadow-lg">
                                        <i class="fas fa-copy"></i> Copy <i class="fas fa-chevron-down ml-1 text-xs"></i>
                                    </button>
                                    <div id="copy-menu-${sig.public_uuid}" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border-2 border-gray-200 z-50">
                                        <button onclick="copyVisualSignature('${sig.public_uuid}')" class="w-full text-left px-4 py-3 hover:bg-green-50 transition flex items-center gap-3 border-b border-gray-100">
                                            <i class="fas fa-eye text-green-600"></i>
                                            <div>
                                                <div class="font-semibold text-gray-900">Copy Visual</div>
                                                <div class="text-xs text-gray-600">Best for Gmail, Outlook</div>
                                            </div>
                                        </button>
                                        <button onclick="copyHtmlSignature('${sig.public_uuid}')" class="w-full text-left px-4 py-3 hover:bg-blue-50 transition flex items-center gap-3 border-b border-gray-100">
                                            <i class="fas fa-code text-blue-600"></i>
                                            <div>
                                                <div class="font-semibold text-gray-900">Copy HTML</div>
                                                <div class="text-xs text-gray-600">Raw HTML code</div>
                                            </div>
                                        </button>
                                        <button onclick="emailSignature('${sig.public_uuid}')" class="w-full text-left px-4 py-3 hover:bg-purple-50 transition flex items-center gap-3">
                                            <i class="fas fa-envelope text-purple-600"></i>
                                            <div>
                                                <div class="font-semibold text-gray-900">Send Email</div>
                                                <div class="text-xs text-gray-600">Email with guides</div>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                                <button onclick="deleteSignature('${sig.public_uuid}')" class="inline-flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm font-semibold shadow-md hover:shadow-lg">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preview -->
                    <div class="p-6">
                        <div class="bg-white border-2 border-dashed border-gray-300 rounded-lg p-6">
                            <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Preview</div>
                            <div class="signature-preview" id="preview-${sig.public_uuid}">
                                <div class="text-gray-400 text-sm">Loading preview...</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            // Render actual signature previews
            signatures.forEach(sig => {
                renderSignaturePreview(sig.public_uuid, sig.template_key, sig.config_json);
            });
        }
        
        // Render actual signature HTML in preview
        async function renderSignaturePreview(uuid, templateKey, config) {
            try {
                const response = await fetch(`${API_BASE}/render.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        templateKey: templateKey,
                        config: config
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.html) {
                    const previewDiv = document.getElementById(`preview-${uuid}`);
                    if (previewDiv) {
                        previewDiv.innerHTML = data.html;
                    }
                }
            } catch (error) {
                console.error('Preview render error:', error);
            }
        }
        
        function editSignature(uuid) {
            window.location.href = `app.html?edit=${uuid}`;
        }
        
        async function copySignature(uuid) {
            try {
                // Get the signature to copy
                const getResponse = await fetch(`${API_BASE}/signatures.php?uuid=${uuid}`, {
                    credentials: 'include'
                });
                const getData = await getResponse.json();
                
                if (!getData.success) {
                    throw new Error('Signature not found');
                }
                
                const original = getData.signature;
                
                // Prompt for new name
                const newName = prompt('Name for the copied signature:', `${original.title} (Copy)`);
                if (!newName) return; // User cancelled
                
                // Create new signature with same config
                const createResponse = await fetch(`${API_BASE}/signatures.php`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        templateKey: original.template_key,
                        config: original.config_json,
                        title: newName
                    })
                });
                
                const createData = await createResponse.json();
                
                if (createData.success) {
                    // Reload signatures list
                    loadSignatures();
                } else {
                    throw new Error(createData.error || 'Copy failed');
                }
            } catch (error) {
                console.error('Copy error:', error);
                showToast('Failed to copy signature. Please try again.', 'error');
            }
        }
        
        // Toggle copy menu dropdown
        function toggleCopyMenu(uuid) {
            const menu = document.getElementById(`copy-menu-${uuid}`);
            // Close all other menus first
            document.querySelectorAll('[id^="copy-menu-"]').forEach(m => {
                if (m.id !== `copy-menu-${uuid}`) m.classList.add('hidden');
            });
            menu.classList.toggle('hidden');
        }
        
        // Close menus when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('[onclick^="toggleCopyMenu"]') && !e.target.closest('[id^="copy-menu-"]')) {
                document.querySelectorAll('[id^="copy-menu-"]').forEach(m => m.classList.add('hidden'));
            }
        });
        
        // Copy visual signature
        async function copyVisualSignature(uuid) {
            try {
                const previewElement = document.getElementById(`preview-${uuid}`);
                if (!previewElement) {
                    alert('Preview not found');
                    return;
                }
                
                // Create temp div with signature HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = previewElement.innerHTML;
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px';
                document.body.appendChild(tempDiv);
                
                // Select and copy
                const range = document.createRange();
                range.selectNodeContents(tempDiv);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                document.execCommand('copy');
                
                // Cleanup
                selection.removeAllRanges();
                document.body.removeChild(tempDiv);
                
                // Close menu and show success
                document.getElementById(`copy-menu-${uuid}`).classList.add('hidden');
                showToast('Visual signature copied! Paste it directly into your email client.', 'success');
            } catch (error) {
                console.error('Copy visual error:', error);
                showToast('Failed to copy. Try selecting the preview and pressing Ctrl+C', 'error');
            }
        }
        
        // Copy HTML signature
        async function copyHtmlSignature(uuid) {
            try {
                const previewElement = document.getElementById(`preview-${uuid}`);
                if (!previewElement) {
                    showToast('Preview not found', 'error');
                    return;
                }
                
                const html = previewElement.innerHTML;
                await navigator.clipboard.writeText(html);
                
                // Close menu and show success
                document.getElementById(`copy-menu-${uuid}`).classList.add('hidden');
                showToast('HTML copied to clipboard!', 'success');
            } catch (error) {
                console.error('Copy HTML error:', error);
                showToast('Failed to copy HTML', 'error');
            }
        }
        
        // Email signature - store UUID for modal callback
        let currentEmailUuid = null;
        
        function emailSignature(uuid) {
            console.log('üìß emailSignature called with UUID:', uuid);
            currentEmailUuid = uuid;
            console.log('‚úì currentEmailUuid set to:', currentEmailUuid);
            document.getElementById('email-modal').classList.remove('hidden');
            document.getElementById('email-input').value = '';
            document.getElementById('email-input').focus();
        }
        
        function closeEmailModal() {
            document.getElementById('email-modal').classList.add('hidden');
            currentEmailUuid = null;
        }
        
        async function confirmEmail() {
            const email = document.getElementById('email-input').value.trim();
            
            if (!email) {
                showToast('Please enter an email address', 'error');
                return;
            }
            
            // Validate email
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            // Validate UUID is set
            if (!currentEmailUuid) {
                console.error('‚ùå currentEmailUuid is null or undefined!');
                showToast('Error: Signature ID not found. Please try again.', 'error');
                closeEmailModal();
                return;
            }
            
            // Store UUID before closing modal (which clears it)
            const uuidToSend = currentEmailUuid;
            closeEmailModal();
            
            try {
                console.log('üìß Sending signature via email to:', email);
                console.log('üìß Using UUID:', uuidToSend);
                
                // Get signature data
                const getResponse = await fetch(`${API_BASE}/signatures.php?uuid=${uuidToSend}`, {
                    credentials: 'include'
                });
                const getData = await getResponse.json();
                
                if (!getData.success) {
                    throw new Error('Signature not found');
                }
                
                const sig = getData.signature;
                console.log('‚úì Signature loaded:', sig.template_key);
                
                // Send via export API
                console.log('üì§ Calling export API...');
                const sendResponse = await fetch(`${API_BASE}/export.php`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        templateKey: sig.template_key,
                        config: sig.config_json
                    })
                });
                
                const sendData = await sendResponse.json();
                
                if (sendData.success) {
                    document.getElementById(`copy-menu-${uuidToSend}`).classList.add('hidden');
                    showToast(`Signature sent to ${email}! Check your inbox.`, 'success');
                } else {
                    const errorMsg = sendData.error || sendData.message || 'Failed to send email';
                    console.error('Email send failed:', sendData);
                    showToast(errorMsg, 'error');
                }
            } catch (error) {
                console.error('Email error:', error);
                showToast('Network error. Please check your connection and try again.', 'error');
            }
        }
        
        // Close modal on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !document.getElementById('email-modal').classList.contains('hidden')) {
                closeEmailModal();
            }
            if (e.key === 'Enter' && !document.getElementById('email-modal').classList.contains('hidden')) {
                confirmEmail();
            }
        });
        
        async function deleteSignature(uuid) {
            if (!confirm('Are you sure you want to delete this signature? This cannot be undone.')) {
                return;
            }
            
            try {
                // First get the signature to get its ID
                const getResponse = await fetch(`${API_BASE}/signatures.php?uuid=${uuid}`, {
                    credentials: 'include'
                });
                const getData = await getResponse.json();
                
                if (!getData.success) {
                    throw new Error('Signature not found');
                }
                
                // Delete using ID
                const deleteResponse = await fetch(`${API_BASE}/signatures.php?id=${getData.signature.id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const deleteData = await deleteResponse.json();
                
                if (deleteData.success) {
                    // Reload signatures list
                    loadSignatures();
                } else {
                    throw new Error(deleteData.error || 'Delete failed');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showToast('Failed to delete signature. Please try again.', 'error');
            }
        }
        
        // Load signatures on page load
        document.addEventListener('DOMContentLoaded', loadSignatures);
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for IroncrestAuth to be ready
            let attempts = 0;
            while (!window.IroncrestAuth && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!window.IroncrestAuth) {
                console.error('IroncrestAuth not loaded');
                return;
            }
            
            // Wait for auth helpers to be ready
            let authAttempts = 0;
            while (!window.checkAuth && authAttempts < 30) {
                await new Promise(resolve => setTimeout(resolve, 100));
                authAttempts++;
            }
            
            // Check authentication
            try {
                console.log('Checking authentication...');
                
                if (!window.checkAuth) {
                    console.error('Auth helpers not available');
                    window.location.href = 'https://apps.ironcrestsoftware.com/auth.html';
                    return;
                }
                
                const user = await window.checkAuth();
                console.log('Auth result:', user);
                
                if (!user) {
                    console.log('Not authenticated, redirecting to login...');
                    window.location.href = 'https://apps.ironcrestsoftware.com/auth.html';
                    return;
                }
                
                console.log('Authenticated as:', user.email);
                // Authentication successful - page will continue loading
            } catch (error) {
                console.error('Auth error:', error);
                // Fallback: redirect to login
                window.location.href = 'https://apps.ironcrestsoftware.com/auth.html';
            }
        });
    </script>
</body>
</html>
