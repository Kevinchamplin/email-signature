<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Email Signature Generator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-display { font-family: 'Montserrat', sans-serif; }
    </style>
    
    <!-- Unified Authentication -->
    <script src="https://apps.ironcrestsoftware.com/auth/ironcrest-auth.js"></script>
</head>
<body class="bg-gray-50 has-sidebar">

    <!-- Header -->
    <div id="app-header"></div>
    
    <!-- Sidebar -->
    <div id="app-sidebar"></div>
    
    <div id="app-content" class="flex-1">

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Welcome Section -->
        <div class="mb-8">
            <h1 class="text-3xl font-display font-bold text-gray-900 mb-2">
                Welcome back, <span id="user-name" class="text-blue-600">User</span>! ðŸ‘‹
            </h1>
            <p class="text-gray-600">Here's what's happening with your email signatures</p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Stat 1 -->
            <div class="bg-white rounded-xl shadow-md p-6 border-2 border-gray-200 hover:border-blue-400 transition">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-sm font-semibold text-gray-600">Total Signatures</div>
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-signature text-blue-600"></i>
                    </div>
                </div>
                <div class="text-3xl font-bold text-gray-900" id="stat-total">0</div>
            </div>
            
            <!-- Stat 2 -->
            <div class="bg-white rounded-xl shadow-md p-6 border-2 border-gray-200 hover:border-green-400 transition">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-sm font-semibold text-gray-600">Templates Used</div>
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-palette text-green-600"></i>
                    </div>
                </div>
                <div class="text-3xl font-bold text-gray-900" id="stat-templates">0</div>
            </div>
            
            <!-- Stat 3 -->
            <div class="bg-white rounded-xl shadow-md p-6 border-2 border-gray-200 hover:border-purple-400 transition">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-sm font-semibold text-gray-600">Account Status</div>
                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-crown text-purple-600"></i>
                    </div>
                </div>
                <div class="text-lg font-bold text-purple-600" id="stat-status">Grandfathered</div>
            </div>
            
            <!-- Stat 4 -->
            <div class="bg-white rounded-xl shadow-md p-6 border-2 border-gray-200 hover:border-yellow-400 transition">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-sm font-semibold text-gray-600">Member Since</div>
                    <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-calendar text-yellow-600"></i>
                    </div>
                </div>
                <div class="text-xl font-bold text-gray-900" id="stat-member">2025</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <a href="app.html" class="bg-gradient-to-br from-blue-600 to-purple-600 text-white rounded-xl p-6 hover:shadow-xl transition-all transform hover:scale-105">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                        <i class="fas fa-plus text-3xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-1">Create New</h3>
                        <p class="text-blue-100 text-sm">Design a new signature</p>
                    </div>
                </div>
            </a>
            
            <a href="signatures.html" class="bg-gradient-to-br from-green-600 to-teal-600 text-white rounded-xl p-6 hover:shadow-xl transition-all transform hover:scale-105">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                        <i class="fas fa-folder text-3xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-1">My Signatures</h3>
                        <p class="text-green-100 text-sm">View all saved signatures</p>
                    </div>
                </div>
            </a>
            
            <a href="profile.html" class="bg-gradient-to-br from-purple-600 to-pink-600 text-white rounded-xl p-6 hover:shadow-xl transition-all transform hover:scale-105">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                        <i class="fas fa-user-circle text-3xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-1">Edit Profile</h3>
                        <p class="text-purple-100 text-sm">Update your information</p>
                    </div>
                </div>
            </a>
        </div>

        <!-- Recent Signatures -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-clock text-blue-600 mr-2"></i>Recent Signatures
                </h2>
                <a href="signatures.html" class="text-blue-600 hover:text-blue-700 font-semibold text-sm">
                    View All <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
            
            <div id="recent-signatures">
                <div class="text-center py-12 text-gray-400">
                    <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                    <p>Loading your signatures...</p>
                </div>
            </div>
        </div>

    </main>

    </div> <!-- Close app-content -->
    
    <!-- Footer -->
    <div id="app-footer"></div>

    <!-- Scripts -->
    <script>const API_BASE = '../api';</script>
    <script src="js/auth-check.js"></script>
    <script src="https://apps.ironcrestsoftware.com/shared/js/app-registry.js?v=11"></script>
    <script>
        window.IRONCREST_APP = 'email-signature';
        window.IRONCREST_LAYOUT = 'app';
    </script>
    <script src="https://apps.ironcrestsoftware.com/shared/js/layout-v2.js?v=11"></script>
    <script>
        // Load dashboard data
        async function loadDashboard() {
            try {
                // Wait for auth status to be ready
                if (!window.authStatus.checked) {
                    await new Promise(resolve => {
                        window.addEventListener('authStatusReady', resolve, { once: true });
                    });
                }
                
                // Update user name if authenticated
                if (window.authStatus.authenticated && window.authStatus.user) {
                    const user = window.authStatus.user;
                    const userName = user.first_name || user.name || user.email?.split('@')[0] || 'User';
                    document.getElementById('user-name').textContent = userName;
                }
                
                // Load signatures
                const sigResponse = await fetch(`${API_BASE}/signatures.php?action=list`, {
                    credentials: 'include'
                });
                
                if (!sigResponse.ok) {
                    throw new Error('Failed to fetch signatures');
                }
                
                const sigData = await sigResponse.json();
                
                if (sigData.success) {
                    const signatures = sigData.signatures || [];
                    
                    // Update stats
                    document.getElementById('stat-total').textContent = signatures.length;
                    
                    // Count unique templates
                    const uniqueTemplates = new Set(signatures.map(s => s.template_key));
                    document.getElementById('stat-templates').textContent = uniqueTemplates.size;
                    
                    // Display recent signatures (last 3)
                    displayRecentSignatures(signatures.slice(0, 3));
                } else {
                    console.error('Signatures API error:', sigData.error);
                }
                
            } catch (error) {
                console.error('Dashboard load error:', error);
            }
        }
        
        // Display recent signatures
        function displayRecentSignatures(signatures) {
            const container = document.getElementById('recent-signatures');
            
            if (signatures.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-signature text-gray-300 text-5xl mb-4"></i>
                        <p class="text-gray-600 mb-4">No signatures yet</p>
                        <a href="app.html" class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                            <i class="fas fa-plus mr-2"></i>Create Your First Signature
                        </a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = signatures.map(sig => `
                <div class="border-b border-gray-200 last:border-0 py-4 hover:bg-gray-50 transition">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-900 mb-1">${sig.title || 'Untitled'}</h3>
                            <div class="flex items-center gap-4 text-sm text-gray-600">
                                <span><i class="fas fa-palette mr-1"></i>${sig.template_key}</span>
                                <span><i class="fas fa-clock mr-1"></i>${new Date(sig.updated_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <a href="app.html?edit=${sig.public_uuid}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-semibold">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for IroncrestAuth to be ready
            let attempts = 0;
            while (!window.IroncrestAuth && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!window.IroncrestAuth) {
                console.error('IroncrestAuth not loaded');
                return;
            }
            
            // Wait for auth helpers to be ready
            let authAttempts = 0;
            while (!window.checkAuth && authAttempts < 30) {
                await new Promise(resolve => setTimeout(resolve, 100));
                authAttempts++;
            }
            
            // Check authentication
            try {
                if (!window.checkAuth) {
                    console.error('Auth helpers not available');
                    window.location.href = 'https://apps.ironcrestsoftware.com/auth.html';
                    return;
                }
                
                const user = await window.checkAuth();
                
                if (!user) {
                    window.location.href = 'https://apps.ironcrestsoftware.com/auth.html';
                    return;
                }
                
                // Authentication successful - page will continue loading
            } catch (error) {
                console.error('Auth error:', error);
                window.location.href = 'https://apps.ironcrestsoftware.com/auth.html';
            }
        });
    </script>
</body>
</html>
